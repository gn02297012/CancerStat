<!DOCTYPE html>
<html>
    <head>
        <title>癌症死因統計視覺化</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="css/c3.css" rel="stylesheet" type="text/css">
        <script src="js/d3.v3.min.js"></script>
        <script src="js/c3.min.js"></script>
        <script src="codeTable.js"></script>
        <style>
            path {
                stroke: #fff;
                stroke-width: 0.5px;
                fill-rule: evenodd;
            }

            #rankTable {
                float: right;
                position: absolute;
                right: 5%;
            }
        </style>
    </head>
    <body>
        <header>
            <h2>癌症死因統計</h2>
            <p>最多可選擇4個key，資料將會群組起來，並畫出圖。滑鼠移到圖上可以顯示關聯的資料。</p>
        </header>
        <div>
            <span id="filter">
            </span>
            <button onclick="filterData()">Draw</button>
            <div id="detail"> </div>
        </div>
        <div id="rankTable">
            <table border="1">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>key</th>
                        <th>人數</th>
                        <th>百分比</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div id="chart"></div>
        <script>
            //所有載入的資料都放這裡
            var data = [];
            //各層資料出現過的key
            var keys = [];
            //將代碼轉換對應的文字
            var codeParse = function(d) {
//                d['cause'] = cancerCode[d['cause']];
//                d['sex'] = sexCode[d['sex']];
//                d['_age_code'] = d['age_code'] * 1;
//                d['age_code'] = ageCode[d['age_code']];
//                if (d['year'] >= 100) {
//                    d['county'] = county100Code[d['county']];
//                    d['city'] = d['county'].substr(0, 3);
//                } else {
//                    d['city'] = d['county'].substr(0, 2);
//                }
                d['city'] = d['county'].substr(0, 2);
            };
            //載入資料
            for (var i = 100; i <= 102; i++) {
                d3.csv('cancer' + i + '.csv', function(error, csv) {
                    //將原始資料中的代碼轉換成文字，再存起來
                    csv.forEach(function(d) {
                        codeParse(d);
                    });
                    data = data.concat(csv);
                });
            }

            //要有哪些key可以選擇
            var keys = [['未選擇', ''], ['年齡', 'age_code'], ['癌症', 'cause'], ['縣市', 'city'], ['性別', 'sex'], ['年度別', 'year']];
            //預設要選取哪些key
            var defaultSelected = [3, 6, 0, 0];

            //產生出select
            for (var i = 0; i < defaultSelected.length; i++) {
                var slt = d3.select('#filter').append('select')
                        .attr('class', 'key');
                slt.selectAll('option')
                        .data(keys).enter()
                        .append('option')
                        .attr('value', function(d) {
                            return d[1];
                        })
                        .text(function(d) {
                            return d[0];
                        });

                //設定預設選取的項目
                slt.select('option:nth-child(' + (defaultSelected[i]) + ')')
                        .property('selected', true);
            }
        </script>
        <script>
            var width = 800,
                    height = 850,
                    radius = Math.min(width, height) / 2;
            var x = d3.scale.linear()
                    .range([0, 2 * Math.PI]);
            var y = d3.scale.sqrt()
                    .range([0, radius]);
            var color = d3.scale.category20c();
            var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");
            var partition = d3.layout.partition()
                    .children(function(d) {
                        if (d.values.length) {
                            return d.values;
                        } else {
                            d['N'] = d.values;
                        }
                    })
                    .value(function(d) {
                        return d['N'];
                    });
            var arc = d3.svg.arc()
                    .startAngle(function(d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
                    })
                    .endAngle(function(d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
                    })
                    .innerRadius(function(d) {
                        return Math.max(0, y(d.y));
                    })
                    .outerRadius(function(d) {
                        return Math.max(0, y(d.y + d.dy));
                    });
            var filterData = function() {
                //找出要用那些key來處理資料
                var filterKeys = [];
                d3.selectAll('select').forEach(function(d) {
                    return d.forEach(function(e) {
                        if (e.value && (filterKeys.indexOf(e.value) === -1)) {
                            filterKeys.push(e.value);
                        }
                    });
                });
                //初始化keys
                keys = [];
                //將資料分群
                var nest = d3.nest();
                filterKeys.forEach(function(key) {
                    keys.push(d3.nest().key(function(d) {
                        return d[key];
                    }).entries(data).map(function(d) {
                        return d.key;
                    }));
                    nest.key(function(d) {
                        return d[key];
                    });
                });
                nest.rollup(function(d) {
                    return d3.sum(d, function(e) {
                        return e['N'];
                    })
                });
                var nested_data = nest.entries(data);
                console.log(nested_data);
                draw(nested_data);
                return nested_data;
            };

            var round4 = function(n) {
                return Math.round(n * 1000) / 1000;
            }

            var draw = function(data) {
                //畫line chart
                var x = ['x'].concat(data[0].values.map(function(d) {
                    return d.key;
                }));
                var col = data.map(function(d) {
                    return [d.key].concat(d.values.map(function(e) {
                        return e.value ? e.value : e.values;
                    }));
                });
                col.splice(0, 0, x);
                console.log(col);
                var chart = c3.generate({
                    bindto: '#chart',
                    data: {
                    x: 'x',
                        columns: col
                    }
                });
                //畫partition圖
                var nodes = partition.nodes({key: 'all', values: data});
                svg.selectAll("path").remove();
                var path = svg.selectAll("path")
                        .data(nodes)
                        .enter().append("path")
                        .attr("d", arc)
                        .style("fill", function(d) {
                            return color(d.key);
                            return color((d.children ? d : d.parent).key);
                        })
                        .on("click", click)
                        .on("mouseenter", function(d) {
                            //產生出階層關係的字串
                            var str = d.key ? d.key : '';
                            var e = d;
                            while (e = e.parent) {
                                str = e.key + '=>' + str;
                            }
                            d3.select('#detail').text(str);

                            //將children的資料顯示在表格上
                            if (d.children) {
                                table(d.children);
                            }
                        });

                function table(d) {
                    var tbody = d3.select('#rankTable tbody');
                    tbody.selectAll('tr').remove();
                    var tr = tbody.selectAll('tr')
                            .data(d).enter()
                            .append('tr');
                    tr.selectAll('td')
                            .data(function(d, i) {
                                return [i + 1, d.key, d.value, round4(d.value / d.parent.value * 100)];
                            }).enter()
                            .append('td')
                            .text(function(d) {
                                return d;
                            });
                }

                function click(d) {
                    path.transition()
                            .duration(750)
                            .attrTween("d", arcTween(d));
                }
            }

            //d3.select(self.frameElement).style("height", height + "px");
            // Interpolate the scales!
            function arcTween(d) {
                var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                        yd = d3.interpolate(y.domain(), [d.y, 1]),
                        yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
                return function(d, i) {
                    return i
                            ? function(t) {
                                return arc(d);
                            }
                    : function(t) {
                        x.domain(xd(t));
                        y.domain(yd(t)).range(yr(t));
                        return arc(d);
                    };
                };
            }

        </script>
    </body>
</html>
