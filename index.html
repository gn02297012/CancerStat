<!DOCTYPE html>
<html>
    <head>
        <title>癌症死因統計視覺化</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>

            path {
                stroke: #fff;
                stroke-width: 0.5px;
                fill-rule: evenodd;
            }

        </style>
    </head>
    <body>
        <button onclick="filterData()">Draw</button>
        <div id="filter">

        </div>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="codeTable.js"></script>
        <script>
            var keys = ['', 'cause', 'age_code', 'city',  'sex', 'year'];
            for (var i = 1; i <= 4; i++) {
                var s = d3.select('#filter').append('select')
                        .attr('class', 'key');
                s.selectAll('option')
                        .data(keys).enter()
                        .append('option')
                        .attr('value', function(d) {
                            return d;
                        })
                        .text(function(d) {
                            return d;
                        });
                s.select('option:nth-child(' + (i) + ')')
                        .property('selected', true);
            }
        </script>
        <script>
            var width = 800,
                    height = 850,
                    radius = Math.min(width, height) / 2;

            var x = d3.scale.linear()
                    .range([0, 2 * Math.PI]);

            var y = d3.scale.sqrt()
                    .range([0, radius]);

            var color = d3.scale.category20c();

            var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

            var partition = d3.layout.partition()
                    .children(function(d) {
                        if (d.values.length) {
                            return d.values;
                        } else {
                            d['N'] = d.values;
                        }
                    })
                    .value(function(d) {
                        return d['N'];
                    });

            var arc = d3.svg.arc()
                    .startAngle(function(d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
                    })
                    .endAngle(function(d) {
                        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
                    })
                    .innerRadius(function(d) {
                        return Math.max(0, y(d.y));
                    })
                    .outerRadius(function(d) {
                        return Math.max(0, y(d.y + d.dy));
                    });

            var data = [];

            d3.csv("cancer102.csv", function(error, root) {
                root.forEach(function(d) {
                    //進行代碼對照轉換
                    d['cause'] = cancerCode[d['cause']];
                    d['sex'] = sexCode[d['sex']];
                    d['age_code'] = ageCode[d['age_code']];
                    if (d['year'] >= 100) {
                        d['county'] = county100Code[d['county']];
                        d['city'] = d['county'].substr(0, 3);
                    } else {
                        d['city'] = d['county'].substr(0, 2);
                    }
                });
                data = root;
            });

            var filterData = function() {
                var filterKeys = [];
                d3.selectAll('select').forEach(function(d) {
                    return d.forEach(function(e) {
                        if (e.value && (filterKeys.indexOf(e.value) === -1)) {
                            filterKeys.push(e.value);
                        }
                    });
                });
                var nest = d3.nest();
                filterKeys.forEach(function(key) {
                    nest.key(function(d) {
                        return d[key];
                    });
                });
                nest.rollup(function(d) {
                    return d3.sum(d, function(e) {
                        return e['N'];
                    })
                });
                var nested_data = nest.entries(data);
                console.log(nested_data);
                draw(nested_data);
            };

            var draw = function(data) {
                var nodes = partition.nodes({key: 'all', values: data});
                svg.selectAll("path").remove();
                var path = svg.selectAll("path")
                        .data(nodes)
                        .enter().append("path")
                        .attr("d", arc)
                        .style("fill", function(d) {
                            return color((d.children ? d : d.parent).key);
                        })
                        .on("click", click)
                        .on("mouseenter", function(d) {
                            var str = d.key ? d.key : '';
                            var e = d;
                            while (e = e.parent) {
                                str = e.key + '=>' + str;
                            }
                            console.log(str + "\t" + (d.value / nodes[0].value * 100) + "%");
                        });

                function click(d) {
                    path.transition()
                            .duration(750)
                            .attrTween("d", arcTween(d));
                }
            }

            d3.select(self.frameElement).style("height", height + "px");

            // Interpolate the scales!
            function arcTween(d) {
                var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                        yd = d3.interpolate(y.domain(), [d.y, 1]),
                        yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
                return function(d, i) {
                    return i
                            ? function(t) {
                                return arc(d);
                            }
                    : function(t) {
                        x.domain(xd(t));
                        y.domain(yd(t)).range(yr(t));
                        return arc(d);
                    };
                };
            }

        </script>
    </body>
</html>
